---
- name: Ensure the AAP Inventory file is up to date prior to running setup
  hosts: control
  gather_facts: false

  tasks:

    - name: Ensure we have the AAP bundle directory
      register: aap_bundle_dir
      changed_when: false
      ansible.builtin.shell: ls -d /root/ansible-automation-platform-setup-bundle*

    - name: Ensure the Controller is in the file
      loop: "{{ my_controller_server_data['instances'] }}"
      ansible.builtin.blockinfile:
        path: "{{ aap_bundle_dir.stdout }}/inventory"
        insertafter: "[automationcontroller]"
        block: | 
          "{{ item['public_dns_name'] }}"
        state: present
        firstmatch: true

    - name: Ensure the EDA Server is in the file
      loop: "{{ my_eda_server_data['instances'] }}"
      ansible.builtin.blockinfile:
        path: "{{ aap_bundle_dir.stdout }}/inventory"
        insertafter: "[automationedacontroller]"
        block: |
          "{{ item['public_dns_name'] }}"
        state: present
        firstmatch: true